# OpenCode Server API Contract

**Version:** 1.0  
**Port:** 3003  
**Transport:** HTTP/REST + Server-Sent Events (SSE)  
**Generated:** 2026-01-19  
**Status:** Phase 1.2 Complete - Contract Defined

---

## Overview

The OpenCode Server sidecar exposes a REST API for managing AI agent sessions and streaming execution output. It integrates with the main backend via HTTP proxying and follows the same patterns established in the file-browser sidecar.

---

## Base URL

```
http://<pod-ip>:3003
```

**Local Development:**
```
http://localhost:3003
```

**Kubernetes:**
```
http://<project-pod-name>.opencode.svc.cluster.local:3003
```

---

## Authentication

**Approach:** Shared secret validation (same-pod communication)

The opencode-server runs as a sidecar in the same pod as the main backend proxy layer, so network-level isolation provides security. No JWT validation required at the sidecar level.

**Future Enhancement:** Add a shared secret token via environment variable for defense-in-depth:
```
Authorization: Bearer <OPENCODE_SHARED_SECRET>
```

---

## Health Check Endpoints

### `GET /healthz`

**Purpose:** Liveness probe (Kubernetes)  
**Response:** 200 OK if server is running

**Response Body:**
```json
{
  "status": "ok"
}
```

**cURL Example:**
```bash
curl http://localhost:3003/healthz
```

---

### `GET /health`

**Purpose:** Compatibility alias for `/healthz`  
**Response:** Identical to `/healthz`

---

### `GET /ready`

**Purpose:** Readiness probe (Kubernetes)  
**Response:** 200 OK if server can accept requests, 503 if not ready

**Response Body (Ready):**
```json
{
  "status": "ready"
}
```

**Response Body (Not Ready):**
```json
{
  "status": "not ready",
  "error": "workspace not accessible"
}
```

**Readiness Checks:**
- Workspace directory is accessible (e.g., `/workspace` PVC mounted)
- OpenCode runtime is initialized (Bun available)
- File system permissions verified

**cURL Example:**
```bash
curl http://localhost:3003/ready
```

---

## Session Management

### `POST /sessions`

**Purpose:** Create a new OpenCode AI session and start execution  
**Called By:** `backend/internal/service/session_service.go:callOpenCodeStart()`

**Request Body:**
```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "prompt": "Add a unit test for the UserRepository.CreateUser method",
  "model_config": {
    "provider": "openai",
    "model": "gpt-4o-mini",
    "api_key": "sk-decrypted-api-key-from-backend",
    "temperature": 0.7,
    "max_tokens": 4096,
    "enabled_tools": ["read", "write", "bash", "edit"],
    "model_version": "2024-01-01",       // optional
    "api_endpoint": "https://api.openai.com/v1"  // optional
  },
  "system_prompt": "You are a senior software engineer..."  // optional
}
```

**Field Descriptions:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `session_id` | UUID string | Yes | Unique session identifier (generated by backend) |
| `prompt` | String | Yes | Initial user prompt to start the task |
| `model_config` | Object | Yes | AI model configuration |
| `model_config.provider` | String | Yes | Model provider: `openai`, `anthropic`, `local` |
| `model_config.model` | String | Yes | Model name: `gpt-4o-mini`, `claude-3-5-sonnet`, etc. |
| `model_config.api_key` | String | Yes | Decrypted API key from ConfigService (AES-256-GCM) |
| `model_config.temperature` | Float | Yes | Sampling temperature (0.0 to 2.0) |
| `model_config.max_tokens` | Integer | Yes | Maximum tokens in response |
| `model_config.enabled_tools` | Array<String> | Yes | Allowed OpenCode tools |
| `model_config.model_version` | String | No | Specific model version/date |
| `model_config.api_endpoint` | String | No | Custom API endpoint (for local models) |
| `system_prompt` | String | No | Override default OpenCode system prompt |

**Response (201 Created):**
```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "running",
  "created_at": "2026-01-19T21:27:00Z"
}
```

**Response (400 Bad Request):**
```json
{
  "error": "Invalid request: missing required field 'prompt'"
}
```

**Response (409 Conflict):**
```json
{
  "error": "Session with ID 550e8400-e29b-41d4-a716-446655440000 already exists"
}
```

**Response (500 Internal Server Error):**
```json
{
  "error": "Failed to initialize OpenCode session: <details>"
}
```

**cURL Example:**
```bash
curl -X POST http://localhost:3003/sessions \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "prompt": "Add logging to the authentication middleware",
    "model_config": {
      "provider": "openai",
      "model": "gpt-4o-mini",
      "api_key": "sk-test-key",
      "temperature": 0.7,
      "max_tokens": 4096,
      "enabled_tools": ["read", "write", "bash", "edit"]
    }
  }'
```

---

### `GET /sessions/{sessionId}/stream`

**Purpose:** Stream real-time task execution output via Server-Sent Events (SSE)  
**Called By:** `backend/internal/api/tasks.go:TaskOutputStream()`

**URL Parameters:**
- `sessionId` (path): UUID of the session

**Request Headers:**
```
Accept: text/event-stream
Cache-Control: no-cache
Connection: keep-alive
Last-Event-ID: <last-received-event-id>  // optional, for reconnection
```

**Response Headers:**
```
Content-Type: text/event-stream
Cache-Control: no-cache
Connection: keep-alive
X-Accel-Buffering: no  // Disable nginx buffering
```

**SSE Event Format:**
```
event: <event-type>
id: <event-id>
data: <json-payload>

```

**Event Types:**

| Event Type | Description | Data Payload |
|------------|-------------|--------------|
| `output` | Tool execution output (stdout/stderr) | `{"type": "stdout", "text": "...", "timestamp": "..."}` |
| `tool_call` | Agent invoked a tool | `{"tool": "read", "args": {...}, "timestamp": "..."}` |
| `tool_result` | Tool execution completed | `{"tool": "read", "result": {...}, "timestamp": "..."}` |
| `status` | Session status change | `{"status": "running", "timestamp": "..."}` |
| `error` | Error occurred | `{"error": "...", "fatal": true, "timestamp": "..."}` |
| `complete` | Session finished successfully | `{"final_message": "...", "timestamp": "..."}` |
| `heartbeat` | Keep-alive ping | `{}` |

**Event Data Schema (output):**
```json
{
  "type": "stdout",
  "text": "Running tests...\nAll tests passed!",
  "timestamp": "2026-01-19T21:30:15Z"
}
```

**Event Data Schema (tool_call):**
```json
{
  "tool": "bash",
  "args": {
    "command": "npm test",
    "workdir": "/workspace"
  },
  "timestamp": "2026-01-19T21:30:10Z"
}
```

**Event Data Schema (tool_result):**
```json
{
  "tool": "bash",
  "result": {
    "exit_code": 0,
    "stdout": "All tests passed!",
    "stderr": ""
  },
  "timestamp": "2026-01-19T21:30:15Z"
}
```

**Event Data Schema (status):**
```json
{
  "status": "running",
  "progress": 45,
  "timestamp": "2026-01-19T21:30:00Z"
}
```

**Event Data Schema (error):**
```json
{
  "error": "Model API rate limit exceeded",
  "fatal": true,
  "retry_after": 60,
  "timestamp": "2026-01-19T21:30:20Z"
}
```

**Event Data Schema (complete):**
```json
{
  "final_message": "Successfully added unit tests for UserRepository.CreateUser",
  "files_modified": ["/workspace/tests/user_repository_test.go"],
  "timestamp": "2026-01-19T21:35:00Z"
}
```

**SSE Stream Example:**
```
event: status
id: 1
data: {"status": "running", "timestamp": "2026-01-19T21:30:00Z"}

event: tool_call
id: 2
data: {"tool": "read", "args": {"file": "/workspace/src/auth.go"}, "timestamp": "2026-01-19T21:30:05Z"}

event: tool_result
id: 3
data: {"tool": "read", "result": {"content": "package auth..."}, "timestamp": "2026-01-19T21:30:06Z"}

event: output
id: 4
data: {"type": "stdout", "text": "Analyzing authentication middleware...", "timestamp": "2026-01-19T21:30:10Z"}

event: complete
id: 5
data: {"final_message": "Task completed successfully", "timestamp": "2026-01-19T21:35:00Z"}
```

**Reconnection:**
Clients can reconnect with `Last-Event-ID` header to resume from last received event.

**cURL Example:**
```bash
curl -N -H "Accept: text/event-stream" \
  http://localhost:3003/sessions/550e8400-e29b-41d4-a716-446655440000/stream
```

**JavaScript Client Example:**
```javascript
const eventSource = new EventSource(
  `/api/projects/${projectId}/tasks/${taskId}/output?session_id=${sessionId}`
);

eventSource.addEventListener('output', (event) => {
  const data = JSON.parse(event.data);
  console.log(data.text);
});

eventSource.addEventListener('complete', (event) => {
  console.log('Task completed!');
  eventSource.close();
});

eventSource.addEventListener('error', (event) => {
  console.error('Stream error:', event);
  eventSource.close();
});
```

---

### `DELETE /sessions/{sessionId}`

**Purpose:** Cancel a running session and cleanup resources  
**Called By:** Future cancellation UI in frontend

**URL Parameters:**
- `sessionId` (path): UUID of the session to cancel

**Response (200 OK):**
```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "cancelled",
  "cancelled_at": "2026-01-19T21:40:00Z"
}
```

**Response (404 Not Found):**
```json
{
  "error": "Session not found"
}
```

**cURL Example:**
```bash
curl -X DELETE http://localhost:3003/sessions/550e8400-e29b-41d4-a716-446655440000
```

---

### `GET /sessions/{sessionId}/status`

**Purpose:** Get current session status (without streaming)  
**Called By:** Polling fallback if SSE not supported

**URL Parameters:**
- `sessionId` (path): UUID of the session

**Response (200 OK):**
```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "running",
  "created_at": "2026-01-19T21:27:00Z",
  "last_activity": "2026-01-19T21:30:00Z",
  "progress": 45,
  "current_tool": "bash"
}
```

**Status Values:**
- `pending` - Session created, not started
- `running` - Actively executing
- `waiting_input` - Needs human input (Phase 7)
- `completed` - Finished successfully
- `failed` - Terminated with error
- `cancelled` - Cancelled by user

**cURL Example:**
```bash
curl http://localhost:3003/sessions/550e8400-e29b-41d4-a716-446655440000/status
```

---

## Error Handling

### HTTP Status Codes

| Code | Meaning | When |
|------|---------|------|
| 200 | OK | Successful GET request |
| 201 | Created | Successful POST /sessions |
| 400 | Bad Request | Invalid input (missing fields, malformed JSON) |
| 404 | Not Found | Session ID doesn't exist |
| 409 | Conflict | Session ID already exists |
| 500 | Internal Server Error | OpenCode runtime error, filesystem issue |
| 503 | Service Unavailable | Not ready (readiness probe failed) |

### Error Response Format

All errors return JSON with this structure:
```json
{
  "error": "Human-readable error message",
  "details": {  // optional
    "field": "session_id",
    "reason": "must be a valid UUID"
  },
  "timestamp": "2026-01-19T21:30:00Z"
}
```

---

## Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `WORKSPACE_DIR` | `/workspace` | Shared workspace path (PVC mount) |
| `PORT` | `3003` | Server listen port |
| `LOG_LEVEL` | `info` | Logging verbosity: `debug`, `info`, `warn`, `error` |
| `OPENCODE_SHARED_SECRET` | (none) | Optional authentication token |
| `SESSION_TIMEOUT` | `3600` | Max session duration in seconds |
| `MAX_CONCURRENT_SESSIONS` | `5` | Limit concurrent sessions per pod |

---

## Kubernetes Pod Spec Integration

**From `backend/internal/service/pod_template.go`:**

```yaml
containers:
- name: opencode-server
  image: registry.legal-suite.com/opencode/opencode-server-sidecar:latest
  ports:
  - name: http
    containerPort: 3003
    protocol: TCP
  env:
  - name: WORKSPACE_DIR
    value: /workspace
  - name: PORT
    value: "3003"
  - name: LOG_LEVEL
    value: info
  volumeMounts:
  - name: workspace
    mountPath: /workspace
  livenessProbe:
    httpGet:
      path: /healthz
      port: 3003
    initialDelaySeconds: 10
    periodSeconds: 30
    timeoutSeconds: 5
    failureThreshold: 3
  readinessProbe:
    httpGet:
      path: /ready
      port: 3003
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 3
    failureThreshold: 3
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "1Gi"
      cpu: "500m"
```

---

## Proxy Integration

**Backend Proxy Layer:** `backend/internal/api/tasks.go`

The main backend API proxies requests to the opencode-server sidecar:

**Pattern:**
```go
// 1. Resolve pod IP
podIP, err := h.kubernetesService.GetPodIP(ctx, podName, namespace)

// 2. Build sidecar URL
sidecarURL := fmt.Sprintf("http://%s:3003/sessions", podIP)

// 3. Proxy HTTP request
req, _ := http.NewRequestWithContext(ctx, "POST", sidecarURL, body)
resp, _ := httpClient.Do(req)

// 4. Stream SSE response
io.Copy(c.Writer, resp.Body)
```

**SSE Streaming Example (from tasks.go:666):**
```go
sidecarURL := fmt.Sprintf("http://%s:3003/sessions/%s/stream", podIP, sessionID)
req.Header.Set("Accept", "text/event-stream")

resp, _ := httpClient.Do(req)

c.Writer.Header().Set("Content-Type", "text/event-stream")
c.Writer.Header().Set("Cache-Control", "no-cache")
c.Writer.Header().Set("Connection", "keep-alive")

flusher := c.Writer.(http.Flusher)
io.Copy(c.Writer, resp.Body)
flusher.Flush()
```

---

## Security Considerations

### Phase 1 (MVP):
- ✅ Network isolation (same-pod communication only)
- ✅ Workspace sandboxing (chroot to `/workspace`)
- ✅ API key injection from encrypted ConfigService
- ✅ Resource limits (Kubernetes pod spec)

### Phase 2 (Production Hardening):
- [ ] Add shared secret authentication (`OPENCODE_SHARED_SECRET`)
- [ ] Rate limiting per session
- [ ] Audit logging for all API calls
- [ ] Input validation for all prompts (max length, content filtering)
- [ ] Session timeout enforcement
- [ ] Concurrent session limits

---

## References

### Backend Integration Points:
- **Session Start:** `backend/internal/service/session_service.go:219` (callOpenCodeStart)
- **Output Streaming:** `backend/internal/api/tasks.go:666` (TaskOutputStream)
- **Pod Template:** `backend/internal/service/pod_template.go:57` (opencode-server container)

### Similar Sidecar Patterns:
- **File Browser:** `sidecars/file-browser/cmd/main.go` (health checks, route setup)
- **File Browser Proxy:** `backend/internal/api/files.go` (HTTP/WebSocket proxy pattern)

### External Documentation:
- **OpenCode GitHub:** https://github.com/anomalyco/opencode
- **Server-Sent Events Spec:** https://html.spec.whatwg.org/multipage/server-sent-events.html
- **Bun HTTP Server:** https://bun.sh/docs/api/http

---

## Changelog

**2026-01-19 (Phase 1.2):**
- Initial API contract definition
- Documented REST endpoints and SSE streaming protocol
- Defined request/response schemas
- Established health check patterns
- Specified authentication mechanism

---

**Status:** ✅ Phase 1.2 Complete - Ready for Implementation (Phase 2.1)
